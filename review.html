<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>‚ú® Review & Edit Translasi</title>
  <style>
    body { font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; transition: opacity 0.8s ease; }
    .header { background: #222; color: white; padding: 1rem; text-align: center; }
    .content { display: flex; flex: 1; overflow: hidden; }
    .left, .right { padding: 1rem; overflow: auto; }
    .left { width: 40%; background: #f5f5f5; border-right: 1px solid #ccc; }
    .right { width: 60%; background: #fff; font-family: monospace; white-space: pre-wrap; }
    .controls { margin-bottom: 1rem; }
    .entry { margin-bottom: 1rem; }
    .entry label { display: block; font-weight: bold; margin-bottom: 0.25rem; }
    .entry input { width: calc(100% - 140px); padding: 0.5rem; }
    .entry button { margin-left: 0.25rem; padding: 0.5rem 0.75rem; }
    .skipped { background: #ffeeba; padding: 0.5rem; margin: 0.25rem 0; border-radius: 5px; }
    .section-title { margin-top: 2rem; font-size: 1.1em; font-weight: bold; border-top: 1px solid #ccc; padding-top: 0.5rem; }
    .save-btn { margin-top: 1rem; padding: 0.6rem 1.2rem; background: dodgerblue; color: white; font-weight: bold; border: none; border-radius: 5px; cursor: pointer; text-decoration: none; display: inline-block; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid white; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; vertical-align: middle; margin-left: 8px; }
    body.fade-out { opacity: 0; pointer-events: none; }
  </style>
</head>
<body>
  <div class="header">
    <h1>üîç Review & Edit Translasi</h1>
  </div>
  <div class="content">
    <div class="left">
      <div class="controls">
        <label>
          Bahasa: 
          <select id="selFrom" disabled>
            <option value="ja">JP</option>
            <option value="en">EN</option>
            <option value="id">ID</option>
          </select>
          ‚Üí
          <select id="selTo" disabled>
            <option value="id">ID</option>
            <option value="en">EN</option>
            <option value="ja">JP</option>
          </select>
        </label>
      </div>
      <div id="translatedSection"></div>
      <div class="section-title">‚ùå Dilewati / Belum Diterjemahkan</div>
      <div id="skippedSection"></div>
      <button id="saveBtn" class="save-btn" onclick="saveReview()">üìÖ Simpan</button>
    </div>
    <div class="right">
      <pre id="fullJson"></pre>
    </div>
  </div>

  <script>
    let json = {};
    let file = '';

    async function fetchJson(path) {
      const res = await fetch(path);
      if (!res.ok) throw new Error(`Gagal ambil ${path}`);
      return res.json();
    }

    async function translateText(text, from, to) {
      const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${from}&tl=${to}&dt=t&q=${encodeURIComponent(text)}`);
      const data = await res.json();
      return data?.[0]?.[0]?.[0] || text;
    }

    async function loadReview() {
      try {
        const params = new URLSearchParams(location.search);
        file = params.get('file');
        if (!file) throw new Error('Parameter file hilang');

        const [review, originalJson] = await Promise.all([
          fetchJson('logs/' + file),
          fetchJson('uploads/' + file)
        ]);

        json = originalJson;

        const from = review.from || 'ja';
        const to = review.to || 'id';
        document.getElementById('selFrom').value = from;
        document.getElementById('selTo').value = to;

        const revTrans = review.translated || [];
        const revSkip = review.skipped || [];

        const fJson = document.getElementById('fullJson');

        function refresh() {
          fJson.textContent = JSON.stringify(json, null, 2);
        }

        function updateJson(obj, path, val) {
          const keys = path.split('.');
          let ref = obj;
          for (let i = 0; i < keys.length - 1; i++) {
            if (!(keys[i] in ref)) return;
            ref = ref[keys[i]];
          }
          ref[keys[keys.length - 1]] = val;
          refresh();
        }

        refresh();

        const tDiv = document.getElementById('translatedSection');
        revTrans.forEach((entry, i) => {
          const div = document.createElement('div');
          div.className = 'entry';

          const label = document.createElement('label');
          label.textContent = `#${i + 1} (${entry.path})`;

          const input = document.createElement('input');
          input.value = entry.translated;
          input.dataset.path = entry.path;
          input.dataset.original = entry.original;
          input.dataset.initial = entry.translated;

          input.addEventListener('input', e => {
            const newVal = e.target.value;
            updateJson(json, entry.path, newVal);
          });

          const btnT = document.createElement('button');
          btnT.textContent = 'üîÅ';
          btnT.title = 'Translate ulang';
          btnT.onclick = async () => {
            btnT.textContent = '‚è≥';
            const result = await translateText(input.dataset.original, from, to);
            input.value = result;
            input.dataset.initial = result;
            updateJson(json, entry.path, result);
            btnT.textContent = 'üîÅ';
          };

          const btnR = document.createElement('button');
          btnR.textContent = 'üîÑ';
          btnR.title = 'Reset ke original';
          btnR.onclick = () => {
            input.value = input.dataset.original;
            updateJson(json, entry.path, input.dataset.original);
          };

          div.append(label, input, btnT, btnR);
          tDiv.appendChild(div);
        });

        const sDiv = document.getElementById('skippedSection');
        revSkip.forEach((val, idx) => {
          const d = document.createElement('div');
          d.className = 'skipped';
          d.textContent = `#${idx + 1}: "${val}"`;
          sDiv.appendChild(d);
        });
      } catch (err) {
        alert(err.message);
        console.error(err);
      }
    }

    function saveReview() {
      const btn = document.getElementById('saveBtn');
      btn.disabled = true;
      btn.innerHTML = '‚è≥ Menyimpan... <span class="spinner"></span>';

      const blob = new Blob([JSON.stringify(json, null, 2)], { type: 'application/json' });
      const formData = new FormData();
      formData.append('filename', file);
      formData.append('data', blob, 'data.json');

      fetch('save_review.php', {
        method: 'POST',
        body: formData
      })
      .then(res => res.json())
      .then(result => {
        if (result.success && result.file) {
          const downloadLink = document.createElement('a');
          downloadLink.href = `download.php?file=${result.file}`;
          downloadLink.textContent = 'üìÇ Download';
          downloadLink.className = 'save-btn';
          downloadLink.onclick = () => {
            document.body.classList.add('fade-out');
            setTimeout(() => {
              window.location.href = 'index.html';
            }, 3500);
          };
          btn.replaceWith(downloadLink);
        } else {
          alert('Gagal menyimpan');
          btn.disabled = false;
          btn.textContent = 'üìÖ Simpan';
        }
      })
      .catch(err => {
        alert('Error saat menyimpan');
        console.error(err);
        btn.disabled = false;
        btn.textContent = 'üìÖ Simpan';
      });
    }

    loadReview();
  </script>
</body>
</html>